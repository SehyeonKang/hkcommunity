<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments.html :: head"></head>
<body>
  <div th:replace="fragments.html :: main-nav"></div>
  <div class="container">
    <div th:replace="fragments.html :: post-info">게시글 제목</div>
    <div class="row px-3 justify-content-center">
      <div class="col-sm-8 pt-3">
        <div th:utext="${post.content}">게시글 내용</div>
        <br>
        <div th:replace="fragments.html :: like-button">추천 버튼</div>
        <hr style="border: solid 1px darkgray;">

        <div class="card mb-2">
          <div class="card-header bg-light">
            <i class="fa fa-comments-o" id="comment-icon"></i>
            <span class="ml-2">댓글</span>
          </div>
        </div>

        <!--/* 댓글 리스트 */-->
        <div class="cm_list"></div>
        <br>
        <br>

        <!--/* 댓글 작성 */-->
        <div class="cm_write">
          <div class="card mb-2">
            <div class="card-header bg-light">
              <i class="bi bi-pencil-square"></i>
              <span class="ml-2">댓글 쓰기</span>
            </div>
            <div class="card-body" id="writeCommentCardBody">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">
                  <fieldset>
                    <div class="cm_input">
                      <p><textarea class="form-control" id="content" name="reply_content"
                                   onkeyup="countingLength(this);" rows="3"></textarea></p>
                      <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-dark" onclick="saveComment();">작성</button>
                      </div>
                    </div>
                  </fieldset>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <hr style="border: solid 1px darkgray;">
        <div class="form-group d-flex justify-content-end">
          <button class="btn btn-secondary" type="submit" onclick="location.href='/announcement'">목록으로</button>
        </div>
      </div>
    </div>
    <div th:replace="fragments.html :: footer"></div>
  </div>
  <script th:replace="fragments.html :: like-check"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/

    var header = $("meta[name='_csrf_header']").attr('content');
    var token = $("meta[name='_csrf']").attr('content');

    window.onload = () => {
      findAllComment();
    }

    // 전체 댓글 조회
    function findAllComment() {

      const postId = [[ ${post.id} ]];
      const accountId = [[ ${account.id} ]]

      $.ajax({
        url: `/api/posts/${postId}/comments`,
        beforeSend: function (xhr) {
          xhr.setRequestHeader(header, token);
        },
        type: 'get',
        dataType: 'json',
        async: false,
        success: function (response) {

          console.log(response);

          // 1. 조회된 데이터가 없는 경우
          if (!response.result.data.length) {
            document.querySelector('.cm_list').innerHTML = '<div class="cm_none"><p>등록된 댓글이 없습니다.</p></div>';
            return false;
          }

          // 2. 렌더링 할 HTML을 저장할 변수
          let commentHtml = '';

          // 3. 댓글 HTML 추가
          response.result.data.forEach(row => {
            commentHtml += `
                              <div class="card py-0 mt-3">
                                  <div class="card-header bg-light">
                                      <span class="comment-writer"><span class="card-text">${row.account.nickname}</span></span>
                                      <a sec:authorize="isAuthenticated()" th:if="${row.account.id == accountId}">
                                          <a class="comment-delete"><i class="bi bi-trash3"></i><span class="card-text ml-1">삭제</span></a>
                                          <a class="comment-edit"><i class="fa fa-pencil"></i><span class="card-text ml-1">수정</span></a>
                                      </a>
                                      <a class="comment-reply"><i class="fa fa-comment fa"></i><span class="card-text ml-1">답글</span></a>
                                      <span class="date" id="commentDate">${dayjs(row.createdDateTime).format('YYYY-MM-DD HH:mm')}</span>
                                  </div>
                                  <div class="card-body">
                                      <span class="comment-content"><span class="card-text" th:id="'commentContent' + ${row.id}">${row.content}</span></span>
                                  </div>
                              </div>
                            `;
          })

          // 4. class가 "cm_list"인 요소를 찾아 HTML을 렌더링
          document.querySelector('.cm_list').innerHTML = commentHtml;
        },
        error: function (request, status, error) {
          console.log(error)
        }
      })
    }

    // 댓글 길이 카운팅
    function countingLength(content) {
      if (content.value.length > 300) {
        alert('댓글을 300자 이하로 입력해 주세요.');
        content.value = content.value.substring(0, 300);
        content.focus();
      }
    }

    // 댓글 저장
    function saveComment() {

      const content = document.getElementById('content');
      const postId = [[ ${post.id} ]];
      const accountId = [[ ${account.id} ]];
      const params = {
        content: content.value,
        postId: postId,
        accountId: accountId,
        parentId: null
      }

      $.ajax({
        url: `/api/comments`,
        beforeSend: function (xhr) {
          xhr.setRequestHeader(header, token);
        },
        type: 'post',
        contentType: 'application/json; charset=utf-8',
        dataType: 'json',
        data: JSON.stringify(params),
        async: false,
        success: function (response) {
          content.value = '';
          findAllComment();

          console.log(response);
          console.log(JSON.stringify(params));
        },
        error: function (request, status, error) {
          console.log(error);
        }
      })
    }

    /*]]>*/
  </script>
</body>
</html>